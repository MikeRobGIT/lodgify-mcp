name: NPM Beta Release

on:
  push:
    branches:
      - develop
      - 'feature/*'
      - 'beta/*'
    paths:
      - 'src/**'
      - 'bin/**'
      - 'package.json'
      - 'tsconfig.json'
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Pre-release type'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - alpha
          - rc
      version:
        description: 'Version bump type'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - prerelease
          - prepatch
          - preminor
          - premajor

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  publish-beta:
    name: Publish Beta to NPM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Node.js (for npm)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run tests
        run: bun test
        env:
          LODGIFY_API_KEY: test-api-key
          TEST_MODE: mock
      
      - name: Build
        run: bun run build
      
      - name: Verify build
        run: |
          echo "Verifying build artifacts..."
          [ -f "dist/server.js" ] || exit 1
          [ -f "bin/lodgify-mcp.js" ] || exit 1
          [ -x "bin/lodgify-mcp.js" ] || exit 1
          echo "✅ Build verification passed"
      
      - name: Determine pre-release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PRERELEASE_TAG="${{ github.event.inputs.prerelease }}"
          else
            # Auto-determine based on branch
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            if [[ "$BRANCH_NAME" == "develop" ]]; then
              PRERELEASE_TAG="beta"
            elif [[ "$BRANCH_NAME" == feature/* ]]; then
              PRERELEASE_TAG="alpha"
            elif [[ "$BRANCH_NAME" == beta/* ]]; then
              PRERELEASE_TAG="beta"
            else
              PRERELEASE_TAG="beta"
            fi
          fi
          echo "tag=$PRERELEASE_TAG" >> $GITHUB_OUTPUT
          echo "Using pre-release tag: $PRERELEASE_TAG"
      
      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          # Remove any existing pre-release suffix
          BASE_VERSION=${CURRENT_VERSION%-*}
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "base=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          echo "Base version: $BASE_VERSION"
      
      - name: Check if package exists on npm
        id: package_exists
        run: |
          if npm view @mikerob/lodgify-mcp version 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Package exists on npm"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Package does not exist on npm yet - will use initial version"
          fi
      
      - name: Calculate next pre-release version
        id: next
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          CURRENT="${{ steps.current.outputs.current }}"
          BASE="${{ steps.current.outputs.base }}"
          PACKAGE_EXISTS="${{ steps.package_exists.outputs.exists }}"
          
          # If package doesn't exist, use current version for first publish
          if [ "$PACKAGE_EXISTS" == "false" ]; then
            echo "First time publishing - using version from package.json"
            NEW_VERSION="$CURRENT"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "First publish version: $NEW_VERSION"
            exit 0
          fi
          
          # Get all published versions from NPM
          echo "Fetching published versions from NPM..."
          NPM_VERSIONS=$(npm view @mikerob/lodgify-mcp versions --json 2>/dev/null || echo "[]")
          
          # Determine base version for pre-release
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION_BUMP="${{ github.event.inputs.version }}"
            case "$VERSION_BUMP" in
              prepatch)
                # Increment patch and add pre-release
                IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"
                NEW_BASE="$MAJOR.$MINOR.$((PATCH + 1))"
                ;;
              preminor)
                # Increment minor and add pre-release
                IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"
                NEW_BASE="$MAJOR.$((MINOR + 1)).0"
                ;;
              premajor)
                # Increment major and add pre-release
                IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"
                NEW_BASE="$((MAJOR + 1)).0.0"
                ;;
              *)
                NEW_BASE="$BASE"
                ;;
            esac
          else
            NEW_BASE="$BASE"
          fi
          
          # Find the highest existing pre-release number for this base version and tag
          echo "Looking for existing $NEW_BASE-$TAG.* versions..."
          HIGHEST_NUM=-1
          
          # Use jq to parse JSON and find matching versions
          if command -v jq &> /dev/null && [ "$NPM_VERSIONS" != "[]" ]; then
            MATCHING_VERSIONS=$(echo "$NPM_VERSIONS" | jq -r ".[] | select(. | startswith(\"$NEW_BASE-$TAG.\"))" 2>/dev/null || echo "")
            
            if [ -n "$MATCHING_VERSIONS" ]; then
              echo "Found existing pre-release versions:"
              echo "$MATCHING_VERSIONS"
              
              # Extract the highest number
              for VERSION in $MATCHING_VERSIONS; do
                NUM=$(echo "$VERSION" | sed -n "s/.*-$TAG\.\([0-9]*\).*/\1/p")
                if [ -n "$NUM" ] && [ "$NUM" -gt "$HIGHEST_NUM" ]; then
                  HIGHEST_NUM=$NUM
                fi
              done
            fi
          fi
          
          # Calculate next pre-release number
          NEXT_NUM=$((HIGHEST_NUM + 1))
          NEW_VERSION="$NEW_BASE-$TAG.$NEXT_NUM"
          
          echo "Highest existing pre-release number: $HIGHEST_NUM"
          echo "Next pre-release number: $NEXT_NUM"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Next version: $NEW_VERSION"
      
      - name: Update package.json version
        run: |
          NEW_VERSION="${{ steps.next.outputs.version }}"
          npm version "$NEW_VERSION" --no-git-tag-version
          echo "Updated package.json to version $NEW_VERSION"
      
      - name: Verify NPM authentication
        run: |
          echo "Verifying NPM authentication..."
          npm whoami || (echo "❌ NPM authentication failed. Please check NPM_TOKEN secret." && exit 1)
          echo "✅ NPM authentication successful"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Run npm publish dry-run
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          echo "Running dry-run for version ${{ steps.next.outputs.version }} with tag: $TAG"
          npm publish --dry-run --tag "$TAG" --access public 2>&1 | tee dry-run.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "❌ Dry-run failed. See output above for details."
            exit 1
          fi
          echo "✅ Dry-run successful"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish to npm with beta tag
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          echo "Publishing version ${{ steps.next.outputs.version }} with tag: $TAG"
          
          # Capture both stdout and stderr, and preserve exit code
          npm publish --tag "$TAG" --provenance --access public 2>&1 | tee publish.log
          PUBLISH_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $PUBLISH_EXIT_CODE -ne 0 ]; then
            echo "❌ npm publish failed with exit code $PUBLISH_EXIT_CODE"
            echo "Error output:"
            grep -i error publish.log || echo "No specific error message found"
            exit $PUBLISH_EXIT_CODE
          fi
          
          echo "✅ Successfully published @mikerob/lodgify-mcp@${{ steps.next.outputs.version }} with tag: $TAG"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Commit version change
        run: |
          VERSION="${{ steps.next.outputs.version }}"
          git add package.json
          git commit -m "chore: bump pre-release version to $VERSION [skip ci]" || echo "No changes to commit"
      
      - name: Push changes
        if: github.event_name == 'push'
        run: |
          git push origin HEAD
        continue-on-error: true
      
      - name: Create pre-release tag
        run: |
          VERSION="${{ steps.next.outputs.version }}"
          git tag -a "v$VERSION" -m "Pre-release v$VERSION"
          git push origin "v$VERSION"
        continue-on-error: true
      
      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.next.outputs.version }}
          prerelease: true
          generate_release_notes: true
          body: |
            ## Lodgify MCP Server v${{ steps.next.outputs.version }} (Pre-release)
            
            ⚠️ **This is a pre-release version for testing purposes**
            
            ### Installation
            
            #### Install specific pre-release version:
            ```bash
            npm install @mikerob/lodgify-mcp@${{ steps.next.outputs.version }}
            ```
            
            #### Install latest ${{ steps.tag.outputs.tag }} version:
            ```bash
            npm install @mikerob/lodgify-mcp@${{ steps.tag.outputs.tag }}
            ```
            
            #### Use with npx:
            ```bash
            npx @mikerob/lodgify-mcp@${{ steps.next.outputs.version }}
            ```
            
            ### Testing
            This pre-release is intended for testing new features and fixes before the stable release.
            Please report any issues you encounter.
            
            ### Changes
            View changes since last stable release in the [commit history](https://github.com/${{ github.repository }}/commits/v${{ steps.next.outputs.version }}).
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## 🚀 Pre-Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ steps.next.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Package**: [@mikerob/lodgify-mcp@${{ steps.next.outputs.version }}](https://www.npmjs.com/package/@mikerob/lodgify-mcp/v/${{ steps.next.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install @mikerob/lodgify-mcp@${{ steps.next.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification" >> $GITHUB_STEP_SUMMARY
          echo "Package was successfully published and can be verified with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm view @mikerob/lodgify-mcp@${{ steps.next.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY